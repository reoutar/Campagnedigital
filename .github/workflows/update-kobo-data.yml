name: Mettre à jour les données Kobo pour le mur digital

on:
  schedule:
    - cron: "0 * * * *"   # Toutes les heures (UTC)
  workflow_dispatch: {}   # Lancement manuel

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Récupérer le dépôt
        uses: actions/checkout@v4

      - name: Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Télécharger les données Kobo
        env:
          KOBOTOOLBOX_TOKEN: ${{ secrets.KOBOTOOLBOX_TOKEN }}
        run: |
          set -e
          echo "Appel de l'API KoboToolbox..."

          curl -s -H "Authorization: Token ${KOBOTOOLBOX_TOKEN}" \
               -H "Accept: application/json" \
               "https://kf.kobotoolbox.org/api/v2/assets/aRQuqSAatFk3vTpByCf9hN/data/?format=json" \
               -o raw_kobo.json

          echo "Réponse sauvegardée dans raw_kobo.json"

      - name: Générer data_oranger.json
        shell: python
        run: |
          import json
          from pathlib import Path

          raw_path = Path("raw_kobo.json")
          if not raw_path.exists():
              raise SystemExit("raw_kobo.json introuvable après l'appel API.")

          data = json.loads(raw_path.read_text(encoding="utf-8"))

          # Kobo v2: { count, next, previous, results: [...] }
          results = data.get("results", [])

          records = []
          for r in results:
              records.append({
                  "_id": r.get("_id"),
                  "stickers": r.get("stickers", ""),
                  "province": r.get("province", ""),
                  "Engagement_sexe": r.get("Engagement_sexe") or r.get("engagement_sexe") or "",
                  "_submission_time": r.get("_submission_time") or r.get("_submitted_at") or "",
              })

          out_path = Path("data_oranger.json")
          out_path.write_text(
              json.dumps(records, ensure_ascii=False, indent=2),
              encoding="utf-8"
          )

          print(f"Wrote {len(records)} records to {out_path}")

      - name: Vérifier s'il y a des changements
        id: gitdiff
        run: |
          if git status --porcelain | grep -q "data_oranger.json"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Configurer Git et pousser les changements
        if: steps.gitdiff.outputs.changed == 'true'
        run: |
          echo "Changements détectés, commit en cours..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data_oranger.json raw_kobo.json
          git commit -m "Auto-update data_oranger.json from Kobo" || echo "Rien à committer"
          git push origin "$(git rev-parse --abbrev-ref HEAD)"
