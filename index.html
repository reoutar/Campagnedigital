<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>16 JOURS D'ACTIVISME– ENGAGEMENT DIGITAL CONTRE LES VIOLENCES FAITES AUX FEMMES ET FILLES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --orange: #f58220;
      --orange-soft: #ffd2a3;
      --orange-neon: #ffb347;
      --blue-onu: #0b3b70;
      --blue-deep: #020617;
      --bg: #0b3b70;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --radius-xl: 22px;
      --radius-md: 16px;
      --radius-sm: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), transparent 55%),
        radial-gradient(circle at bottom right, rgba(245, 158, 11, 0.25), transparent 60%),
        linear-gradient(135deg, #0b3b70, #020617);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* HEADER */
    .header {
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.18), transparent 60%),
        linear-gradient(120deg, #f97316, #facc15);
      color: white;
      padding: 16px 20px;
      border-radius: var(--radius-xl);
      border: 1px solid rgba(254, 243, 199, 0.8);
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .header-title {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .header-sub {
      font-size: 13px;
    }

    .header-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tag {
      background: rgba(0, 0, 0, 0.22);
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(254, 249, 195, 0.6);
    }

    .tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 9px rgba(34, 197, 94, 0.8);
    }

    /* INFO */
    .info {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* KPI BAR */
    .kpi-bar {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    @media (max-width: 768px) {
      .kpi-bar {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .kpi-card {
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .kpi-dot-jem {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .kpi-dot-non {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #38bdf8;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
    }

    .kpi-dot-pas {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #f97316;
      box-shadow: 0 0 10px rgba(249, 115, 22, 0.9);
    }

    .kpi-dot-total {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #a855f7;
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.9);
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 700;
    }

    .kpi-sub {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* FILTERS */
    .filters-card {
      background:
        linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 10px 12px;
      margin-bottom: 12px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 140px;
      flex: 1 1 0;
    }

    .filter-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    .filter-select {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      color: var(--text-main);
      font-size: 11px;
      padding: 4px 10px;
      outline: none;
    }

    .filter-select:focus {
      border-color: var(--orange-soft);
      box-shadow: 0 0 0 1px rgba(245, 130, 32, 0.7);
    }

    .filter-badge {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* MAP CARD */
    .map-card {
      background:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.18), transparent 60%),
        radial-gradient(circle at bottom right, rgba(245, 158, 11, 0.16), transparent 60%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
      border-radius: var(--radius-xl);
      padding: 10px 12px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      margin-bottom: 12px;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      gap: 6px;
    }

    .map-title {
      font-size: 14px;
      font-weight: 700;
    }

    .map-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    #rdc-map {
      width: 100%;
      height: 260px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(51, 65, 85, 0.9);
      overflow: hidden;
    }

    /* WALL */
    .wall-card {
      background:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.16), transparent 60%),
        radial-gradient(circle at bottom right, rgba(245, 158, 11, 0.14), transparent 60%),
        linear-gradient(150deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
      border-radius: var(--radius-xl);
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }

    .wall-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 6px;
    }

    .wall-title {
      font-size: 14px;
      font-weight: 700;
    }

    .wall-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .wall-counter {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
    }

    .wall-scroll {
      border-radius: var(--radius-md);
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 6px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(2, 6, 23, 0.98));
      max-height: 320px;
      overflow-y: auto;
    }

    .wall-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
    }

    .tile {
      background:
        radial-gradient(circle at top, rgba(248, 250, 252, 0.10), rgba(15, 23, 42, 0.96));
      border-radius: 14px;
      padding: 6px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 14px rgba(15, 23, 42, 0.9);
      min-height: 100px;
    }

    .tile-badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(2, 6, 23, 0.9);
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(248, 250, 252, 0.18);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--orange);
      box-shadow: 0 0 9px rgba(245, 130, 32, 0.9);
    }

    .tile-image-wrap {
      border-radius: 10px;
      overflow: hidden;
      background: #020617;
      min-height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .tile-image {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .tile-meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
    }

    .tile-province {
      font-size: 10px;
      font-weight: 600;
    }

    .tile-sex {
      font-size: 9px;
      color: var(--text-muted);
    }

    .tile-time {
      font-size: 9px;
      color: var(--text-muted);
      text-align: right;
    }

    .footer-note {
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    /* ---------- STYLES SPÉCIAUX IMPRESSION / PDF ---------- */

    @page {
      size: A4 portrait;
      margin: 10mm;
    }

    @media print {
      html, body {
        background: #ffffff !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .page {
        max-width: 100%;
        padding: 0;
      }

      /* On réduit légèrement la carte pour tenir sur la page */
      #rdc-map {
        height: 200px;
      }

      /* On supprime les ombres qui peuvent salir l'impression */
      .header,
      .kpi-card,
      .filters-card,
      .map-card,
      .wall-card,
      .tile {
        box-shadow: none !important;
      }

      /* Éviter les coupures bizarres au milieu des blocs principaux */
      .header,
      .kpi-bar,
      .filters-card,
      .map-card,
      .wall-card {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- HEADER -->
    <header class="header">
      <div class="header-title">MUR DIGITAL – #ORANGERLARDC</div>
      <div class="header-sub">
        Engagements citoyens contre les violences faites aux femmes et aux filles · 16 jours d’activisme
      </div>
      <div class="header-tags">
        <span class="tag">
          <span class="tag-dot"></span>
          #Jem'engage
        </span>
        <span class="tag">
          <span class="tag-dot"></span>
          #NonViolences
        </span>
        <span class="tag">
          <span class="tag-dot"></span>
          #PasD'Excuse
        </span>
      </div>
    </header>

    <div class="info">
      Les visuels ci-dessous sont générés à partir du fichier <code>data_oranger.json</code> (mis à jour automatiquement depuis KoboToolbox via GitHub Actions).
    </div>

    <!-- KPI BAR -->
    <section class="kpi-bar">
      <div class="kpi-card">
        <div class="kpi-label">
          <span class="kpi-dot-jem"></span>
          #Jem'engage
        </div>
        <div class="kpi-value" id="kpi-jemengage">0</div>
        <div class="kpi-sub">Engagements individuellement cochés</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">
          <span class="kpi-dot-non"></span>
          #NonViolences
        </div>
        <div class="kpi-value" id="kpi-nonviolences">0</div>
        <div class="kpi-sub">Engagements contre les violences</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">
          <span class="kpi-dot-pas"></span>
          #PasD'Excuse
        </div>
        <div class="kpi-value" id="kpi-pasdexcuse">0</div>
        <div class="kpi-sub">Refus clair de toute violence</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">
          <span class="kpi-dot-total"></span>
          Total vignettes
        </div>
        <div class="kpi-value" id="kpi-total">0</div>
        <div class="kpi-sub">Nombre total de vignettes affichées</div>
      </div>
    </section>

    <!-- FILTERS -->
    <section class="filters-card">
      <div class="filters-row">
        <div class="filter-group">
          <label class="filter-label" for="filter-sticker">Filtrer par engagement</label>
          <select id="filter-sticker" class="filter-select">
            <option value="">Tous les engagements</option>
            <option value="jemengage">#Jem'engage</option>
            <option value="nonviolences">#NonViolences</option>
            <option value="pasdexcuse">#PasD'Excuse</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label" for="filter-province">Filtrer par province</label>
          <select id="filter-province" class="filter-select">
            <option value="">Toutes les provinces</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label" for="filter-sexe">Filtrer par sexe</label>
          <select id="filter-sexe" class="filter-select">
            <option value="">Tous les genres</option>
            <option value="femme">Femmes</option>
            <option value="homme">Hommes</option>
          </select>
        </div>

        <div class="filter-badge">
          <span id="filter-summary">Aucun filtre appliqué</span>
        </div>
      </div>
    </section>

    <!-- CARTE RDC -->
    <section class="map-card">
      <div class="map-header">
        <div>
          <div class="map-title">Carte des engagements – RDC</div>
          <div class="map-sub">
            Chaque point agrège les engagements par province (à partir des données KoboToolbox).
          </div>
        </div>
        <div style="font-size:11px; color:var(--text-muted);">
          Zoomez et déplacez la carte pour explorer
        </div>
      </div>
      <div id="rdc-map"></div>
    </section>

    <!-- WALL -->
    <section class="wall-card">
      <div class="wall-header-row">
        <div>
          <div class="wall-title">Mur des engagements</div>
          <div class="wall-sub">
            Chaque vignette représente un visuel d’engagement soumis via le formulaire Kobo.
          </div>
        </div>
        <div class="wall-counter">
          <span id="wall-count">0</span> vignettes affichées
        </div>
      </div>

      <div class="wall-scroll">
        <div id="wall-grid" class="wall-grid">
          <!-- Vignettes générées en JS -->
        </div>
      </div>
    </section>

    <div class="footer-note">
      Ce mur digital valorise les engagements soumis via votre formulaire Kobo. Merci pour votre mobilisation.
    </div>
  </div>

  <script>
    // URL des images des stickers (repo GitHub)
    const STICKER_IMAGES = {
      "jemengage": "https://raw.githubusercontent.com/reoutar/Campagnedigital/main/images/Jemengage.png",
      "nonviolences": "https://raw.githubusercontent.com/reoutar/Campagnedigital/main/images/NonViolence.png",
      "pasdexcuse": "https://raw.githubusercontent.com/reoutar/Campagnedigital/main/images/PasExcuse.png"
    };

    const STICKER_LABELS = {
      "jemengage": "#Jem'engage",
      "nonviolences": "#NonViolences",
      "pasdexcuse": "#PasD'Excuse"
    };

    const wallGrid = document.getElementById("wall-grid");
    const wallCount = document.getElementById("wall-count");

    const kpiJem = document.getElementById("kpi-jemengage");
    const kpiNon = document.getElementById("kpi-nonviolences");
    const kpiPas = document.getElementById("kpi-pasdexcuse");
    const kpiTotal = document.getElementById("kpi-total");

    const filterSticker = document.getElementById("filter-sticker");
    const filterProvince = document.getElementById("filter-province");
    const filterSexe = document.getElementById("filter-sexe");
    const filterSummary = document.getElementById("filter-summary");

    let expandedData = [];
    let stickerStats = {
      jemengage: 0,
      nonviolences: 0,
      pasdexcuse: 0
    };

    const currentFilters = {
      sticker: "",
      province: "",
      sexe: ""
    };

    // Coordonnées approximatives des provinces de la RDC
    const PROVINCE_COORDS = {
      "Kinshasa":        { lat: -4.325,  lon: 15.322 },
      "Bas-Uele":        { lat: 3.85,    lon: 25.5   },
      "Equateur":        { lat: 1.5,     lon: 19.5   },
      "Haut-Katanga":    { lat: -11.6,   lon: 27.5   },
      "Haut-Lomami":     { lat: -8.2,    lon: 25.2   },
      "Haut-Uele":       { lat: 3.2,     lon: 28.5   },
      "Ituri":           { lat: 1.8,     lon: 30.0   },
      "Kasaï":           { lat: -5.0,    lon: 21.5   },
      "Kasaï-Central":   { lat: -6.0,    lon: 22.0   },
      "Kasaï-Oriental":  { lat: -6.5,    lon: 24.0   },
      "Kongo-Central":   { lat: -5.2,    lon: 13.5   },
      "Kwango":          { lat: -5.5,    lon: 18.0   },
      "Kwilu":           { lat: -5.2,    lon: 18.8   },
      "Lomami":          { lat: -6.5,    lon: 24.5   },
      "Lualaba":         { lat: -10.6,   lon: 25.0   },
      "Maï-Ndombe":      { lat: -2.0,    lon: 18.5   },
      "Maniema":         { lat: -3.0,    lon: 26.5   },
      "Mongala":         { lat: 2.0,     lon: 21.5   },
      "Nord-Kivu":       { lat: 0.3,     lon: 29.3   },
      "Nord-Ubangi":     { lat: 3.6,     lon: 20.8   },
      "Sankuru":         { lat: -2.5,    lon: 24.0   },
      "Sud-Kivu":        { lat: -3.0,    lon: 28.8   },
      "Sud-Ubangi":      { lat: 2.6,     lon: 19.8   },
      "Tanganyika":      { lat: -6.0,    lon: 27.8   },
      "Tshopo":          { lat: 1.0,     lon: 25.0   },
      "Tshuapa":         { lat: -0.5,    lon: 22.0   }
    };

    let map;
    let provinceLayerGroup;

    function initMap() {
      const mapContainer = document.getElementById("rdc-map");
      if (!mapContainer) return;

      map = L.map("rdc-map", {
        zoomControl: true,
        attributionControl: false
      }).setView([-2.5, 23.5], 5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 10,
        minZoom: 3
      }).addTo(map);

      provinceLayerGroup = L.layerGroup().addTo(map);
    }

    function updateMapFromData() {
      if (!map || !provinceLayerGroup) return;

      provinceLayerGroup.clearLayers();

      const countsByProvince = {};
      for (const row of expandedData) {
        const p = row.province || "";
        if (!p) continue;
        countsByProvince[p] = (countsByProvince[p] || 0) + 1;
      }

      for (const [province, count] of Object.entries(countsByProvince)) {
        const coords = PROVINCE_COORDS[province];
        if (!coords) continue;

        const radius = Math.min(24, Math.max(6, 6 + Math.sqrt(count) * 3));

        const circle = L.circleMarker([coords.lat, coords.lon], {
          radius: radius,
          color: "#f97316",
          weight: 1,
          fillColor: "#fb923c",
          fillOpacity: 0.8
        });

        circle.bindPopup(
          `<strong>${province}</strong><br/>${count} engagement(s)`
        );

        circle.addTo(provinceLayerGroup);
      }
    }

    async function loadData() {
      try {
        const resp = await fetch(
          "https://raw.githubusercontent.com/reoutar/Campagnedigital/main/data_oranger.json?nocache=" + Date.now()
        );

        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }

        const json = await resp.json();
        const rows = Array.isArray(json) ? json : (json.results || []);

        prepareData(rows);
        populateProvinceFilter();
        updateKpis();

        if (!map) {
          initMap();
        }
        updateMapFromData();

        renderWall();
      } catch (e) {
        console.error("Erreur chargement data_oranger.json:", e);
        wallGrid.innerHTML = `
          <div style="grid-column: 1 / -1; font-size: 12px; color: #fca5a5;">
            ⚠️ Erreur lors du chargement des données.<br/>
            Vérifiez que <code>data_oranger.json</code> existe bien dans le dépôt et contient un JSON valide.
          </div>
        `;
      }
    }

    function prepareData(rows) {
      expandedData = [];
      stickerStats = {
        jemengage: 0,
        nonviolences: 0,
        pasdexcuse: 0
      };

      for (const row of rows) {
        let raw = row.stickers;
        let codesList = [];

        if (Array.isArray(raw)) {
          codesList = raw;
        } else if (typeof raw === "string") {
          raw = raw.trim();
          if (raw) {
            codesList = raw.split(/\s+/g);
          }
        } else if (raw != null) {
          const s = String(raw).trim();
          if (s) {
            codesList = s.split(/\s+/g);
          }
        }

        if (!codesList.length) {
          for (const v of Object.values(row)) {
            if (typeof v === "string" && /(jemengage|nonviolences|pasdexcuse)/i.test(v)) {
              codesList = v.trim().split(/\s+/g);
              break;
            }
          }
        }

        if (!codesList.length) continue;

        const province = row.province || "";
        const sexe =
          row.Engagement_sexe ||
          row.engagement_sexe ||
          row["Mon_engagement_contr_iolences_en_tant_que"] ||
          row["Mon_engagement_contre_les_violences_en_tant_que"] ||
          row.sexe ||
          "";

        const submission_time = row._submission_time || row._submitted_at || "";

        for (const s of codesList) {
          const code = String(s).toLowerCase();
          if (!code) continue;

          if (code === "jemengage") stickerStats.jemengage += 1;
          if (code === "nonviolences") stickerStats.nonviolences += 1;
          if (code === "pasdexcuse") stickerStats.pasdexcuse += 1;

          expandedData.push({
            _id: row._id,
            sticker: code,
            province: province,
            sexe: sexe,
            submission_time: submission_time
          });
        }
      }

      expandedData.sort((a, b) => {
        if (!a.submission_time || !b.submission_time) return 0;
        return a.submission_time < b.submission_time ? 1 : -1;
      });
    }

    function populateProvinceFilter() {
      const provinces = new Set();
      for (const row of expandedData) {
        if (row.province) provinces.add(row.province);
      }
      const sorted = Array.from(provinces).sort((a, b) =>
        a.localeCompare(b, "fr", { sensitivity: "base" })
      );

      filterProvince.innerHTML = '<option value="">Toutes les provinces</option>';
      for (const p of sorted) {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        filterProvince.appendChild(opt);
      }
    }

    function updateKpis() {
      kpiJem.textContent = stickerStats.jemengage;
      kpiNon.textContent = stickerStats.nonviolences;
      kpiPas.textContent = stickerStats.pasdexcuse;
      kpiTotal.textContent = expandedData.length;
    }

    function formatShortDate(str) {
      if (!str) return "";
      const d = new Date(str);
      if (isNaN(d)) return "";
      return d.toLocaleDateString("fr-FR", {
        day: "2-digit",
        month: "2-digit"
      });
    }

    function buildFilterSummary() {
      const parts = [];
      if (currentFilters.sticker) {
        parts.push("Sticker : " + (STICKER_LABELS[currentFilters.sticker] || currentFilters.sticker));
      }
      if (currentFilters.province) {
        parts.push("Province : " + currentFilters.province);
      }
      if (currentFilters.sexe) {
        parts.push("Sexe : " + currentFilters.sexe);
      }
      filterSummary.textContent = parts.length ? parts.join(" · ") : "Aucun filtre appliqué";
    }

    function renderWall() {
      let filtered = expandedData.slice();

      if (currentFilters.sticker) {
        filtered = filtered.filter(r => r.sticker === currentFilters.sticker);
      }
      if (currentFilters.province) {
        filtered = filtered.filter(r => r.province === currentFilters.province);
      }
      if (currentFilters.sexe) {
        filtered = filtered.filter(
          r => (r.sexe || "").toLowerCase() === currentFilters.sexe.toLowerCase()
        );
      }

      wallCount.textContent = filtered.length.toString();
      buildFilterSummary();

      if (filtered.length === 0) {
        wallGrid.innerHTML = `
          <div style="grid-column: 1 / -1; font-size: 12px; color: #e5e7eb;">
            Aucun engagement ne correspond aux filtres sélectionnés.
          </div>
        `;
        return;
      }

      wallGrid.innerHTML = "";

      for (const row of filtered) {
        const stickerCode = row.sticker;
        const imgSrc = STICKER_IMAGES[stickerCode] || "";
        const label = STICKER_LABELS[stickerCode] || stickerCode;

        const tile = document.createElement("article");
        tile.className = "tile";

        const badge = document.createElement("div");
        badge.className = "tile-badge";
        badge.innerHTML = `<span class="badge-dot"></span><span>${label}</span>`;
        tile.appendChild(badge);

        const imgWrap = document.createElement("div");
        imgWrap.className = "tile-image-wrap";

        if (imgSrc) {
          const img = document.createElement("img");
          img.className = "tile-image";
          img.src = imgSrc;
          img.alt = label;
          imgWrap.appendChild(img);
        } else {
          imgWrap.innerHTML = `<div style="font-size:11px; color:#6b7280; padding:6px; text-align:center;">
            ${label}
          </div>`;
        }

        tile.appendChild(imgWrap);

        const meta = document.createElement("div");
        meta.className = "tile-meta";

        const left = document.createElement("div");
        left.innerHTML = `
          <div class="tile-province">${row.province || "Province inconnue"}</div>
          <div class="tile-sex">${row.sexe || "&nbsp;"}</div>
        `;

        const right = document.createElement("div");
        right.className = "tile-time";
        right.textContent = formatShortDate(row.submission_time);

        meta.appendChild(left);
        meta.appendChild(right);
        tile.appendChild(meta);

        wallGrid.appendChild(tile);
      }
    }

    filterSticker.addEventListener("change", () => {
      currentFilters.sticker = filterSticker.value;
      renderWall();
    });
    filterProvince.addEventListener("change", () => {
      currentFilters.province = filterProvince.value;
      renderWall();
    });
    filterSexe.addEventListener("change", () => {
      currentFilters.sexe = filterSexe.value;
      renderWall();
    });

    loadData();
  </script>
</body>
</html>
